{% extends 'layout.html' %}
{% block title %}Detect Edges {% endblock %}
{% block content %}
    <script>
        function toggleNoiseFields() {
            var checkbox = document.getElementById("noise_check");
            var noiseFields = document.getElementById("noise_fields");
            var noiseType = document.getElementById("noise_type").value;
            var noiseParameterInput = document.getElementById("noise_parameter");

            if (checkbox.checked) {
                noiseFields.style.display = "block";
                if (noiseType === "gauss") {
                    noiseParameterInput.setAttribute("min", "0");
                    noiseParameterInput.setAttribute("max", "100");
                    noiseParameterInput.setAttribute("step", "5");
                } else {
                    noiseParameterInput.setAttribute("min", "0");
                    noiseParameterInput.setAttribute("max", "1");
                    noiseParameterInput.setAttribute("step", "0.05");
                }
            } else {
                noiseFields.style.display = "none";
            }
        }

        function toggleGroundTruthField() {
            var metricsCheck = document.getElementById("calculate_metrics");
            var metricsFields = document.getElementById('metrics_fields');
            var groundTruthInput = document.getElementsByName("ground_truth")[0];

            if (metricsCheck.checked) 
            {
                metricsFields.style.display = 'block';
                groundTruthInput.required = true
            } 
            else 
            {
                metricsFields.style.display = 'none';
                groundTruthInput.required = false;
            }
        }

        function validateForm() 
        {
            var metricsCheck = document.getElementById("calculate_metrics");
            var mainFilesInput = document.getElementsByName("file")[0];
            var mainFiles = mainFilesInput.files;
            var gtFilesInput = document.getElementsByName("ground_truth")[0];
            var gtFiles = gtFilesInput.files;

            if (mainFiles.length === 0) {
                alert("Please upload at least one image.");
                return false;
            }

            if (mainFiles.length > 30) {
                alert("You can upload at most 30 images.");
                return false;
            }

            for (var i = 0; i < mainFiles.length; i++) 
            {
                if (mainFiles[i].size > 5 * 1024 * 1024 || gtFiles[i].size > 5 * 1024 * 1024) 
                {
                    alert("Image size should be less than 5 MB.");
                    return false;
                }
            }

            if (metricsCheck.checked) 
            {
                var groundTruthFiles = document.getElementsByName("ground_truth")[0].files;

                if (mainFiles.length !== groundTruthFiles.length) {
                    alert("Number of original images must match number of ground truth images.");
                    return false;
                }

                return true;
            }
        }
    </script>
    
    <div class="title">{{ method }} edge detection</div>
        <form method="post" enctype="multipart/form-data" onsubmit="return validateForm();" class="input-form">
            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <label for="file" class="form-label" ><h6>Upload your images</h6></label>
                    <input type="file" name="file" aria-label="file example" class="form-control" accept=".jpg, .jpeg, .png" multiple required>
                </div>
              </div>

            <br>

            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <div class="form-check">
                        <input type="checkbox" name="noise_check" id="noise_check" class="form-check-input" onchange="toggleNoiseFields()">
                        <label for="noise_check" class="form-check-label">Add Noise</label>
                    </div>
                </div>
            </div>
            
            <div id="noise_fields" style="display: none;">
                <div class="row mb-3">
                    <div class="col-sm-10 offset-sm-2">
                        <label for="noise_type" class="form-label">Select the <b>type of noise</b></label>
                        <select name="noise_type" id="noise_type" class="form-select" required>
                            <option value="gauss">Gaussian</option>
                            <option value="impulse">Impulse</option>
                            <option value="speckle">Speckle</option>
                        </select>
                        <label for="noise_parameter" class="col-sm-3 col-form-label">Enter the noise <b>parameter</b></label>
                        <input type="number" step="0.05" name="noise_parameter" id="noise_parameter" min="0" max="100" value="0" class="form-control">
                    </div>
                </div>

                <br>
            </div>

            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <div class="form-check">
                        <input type="checkbox" name="calculate_metrics" id="calculate_metrics" class="form-check-input" onchange="toggleGroundTruthField()">
                        <label for="calculate_metrics" class="form-check-label">Calculate Metrics</label>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <div id="metrics_fields" style="display: none;">
                        <label for="ground_truth" class="form-label">Upload <b>Ground Truth</b> Images</label>
                        <input type="file" name="ground_truth" class="form-control" accept=".jpg, .jpeg, .png" multiple>
                    </div>
                </div>
            </div>

            <br>

            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <button type="submit" value="Upload" class="btn btn-primary">Upload</button>
                </div>
            </div>
        </form>
{% endblock %}